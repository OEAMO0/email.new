<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إنشاء وإدارة الإيميل المؤقت</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            background-color: #2c3e50;
            color: white;
            margin: 0;
            padding: 0;
        }

        #container {
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        #email {
            font-size: 1.5em;
            color: #3498db;
            font-weight: bold;
        }

        .message {
            background-color: #34495e;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }

        .button {
            background-color: #1abc9c;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
        }

        .button:hover {
            background-color: #16a085;
        }

        #messageList {
            margin-top: 20px;
        }

        #emailList {
            margin-top: 20px;
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
        }

        #emailList ul {
            list-style-type: none;
            padding: 0;
        }

        #emailList li {
            margin-bottom: 5px;
            cursor: pointer;
            color: #3498db;
        }

        #errorBox {
            color: red;
            font-weight: bold;
            margin-top: 20px;
            display: none;
        }

        #backButton {
            margin-top: 20px;
            display: none;
        }

        #copyButton {
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <div id="container">
        <h1>إنشاء إيميل مؤقت</h1>
        <p>الإيميل الحالي: <span id="email">جاري إنشاء الإيميل...</span></p>
        <button class="button" onclick="createAccount()">إنشاء إيميل جديد</button>
        <button class="button" id="backButton" onclick="goBackToEmail()">العودة إلى الإيميل السابق</button>
        <button class="button" id="copyButton" onclick="copyEmail()">نسخ الإيميل</button>
        <button class="button" id="updateButton" onclick="fetchMessages()">تحديث الرسائل</button>

        <div id="errorBox">حدث خطأ أثناء إنشاء الحساب. حاول مجددًا.</div>

        <div id="messageList">لا توجد رسائل بعد.</div>

        <div id="emailList">
            <h2>الإيميلات السابقة</h2>
            <ul id="emailHistoryList"></ul>
        </div>
    </div>

    <script>
        let account = null;
        let token = null;
        let cachedMessages = {};  // تخزين الرسائل المخزنة بناءً على الإيميل
        let emailHistory = [];     // تعريف متغير لتخزين تاريخ الإيميلات
    
        // إنشاء حساب جديد
        async function createAccount() {
            document.getElementById('email').innerText = 'جاري إنشاء الإيميل...';
            document.getElementById('messageList').innerHTML = 'لا توجد رسائل بعد.';
            document.getElementById('errorBox').style.display = 'none';  // إخفاء الخطأ إذا كان موجودًا
            try {
                const domainRes = await fetch('https://api.mail.tm/domains');
                const domainData = await domainRes.json();
                if (!domainData['hydra:member'] || domainData['hydra:member'].length === 0) {
                    throw new Error("لم يتم العثور على نطاق بريد صالح.");
                }
                const domain = domainData['hydra:member'][0].domain;
                const randomName = Math.random().toString(36).substring(2, 10);
                const address = `${randomName}@${domain}`;
                const password = "Password123!";
    
                const registerRes = await fetch('https://api.mail.tm/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
    
                if (registerRes.ok) {
                    account = { address, password };
                    emailHistory.push(address);  // إضافة الإيميل إلى التاريخ
                    document.getElementById('email').innerText = address;
                    addEmailToList(address);
                    await login();
                    fetchMessages();
                    document.getElementById('backButton').style.display = 'inline-block'; // إظهار زر العودة
                } else {
                    const errorData = await registerRes.json();
                    showError(`فشل في إنشاء الإيميل: ${errorData.message || 'لا يوجد وصف واضح للمشكلة.'}`);
                }
            } catch (error) {
                console.error(error);
                document.getElementById('email').innerText = 'خطأ أثناء إنشاء الإيميل.';
                showError("حدث خطأ أثناء إنشاء الحساب. حاول مجددًا.");
            }
        }
    
        // تسجيل الدخول
        async function login() {
            const loginRes = await fetch('https://api.mail.tm/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: account.address, password: account.password })
            });
            const loginData = await loginRes.json();
            token = loginData.token;
        }
    
        // جلب الرسائل
        async function fetchMessages() {
            if (!token || !account) {
                alert("يجب إنشاء إيميل أولاً!");
                return;
            }
    
            // التحقق مما إذا كانت الرسائل للإيميل مخزنة بالفعل
            if (cachedMessages[account.address]) {
                displayMessages(cachedMessages[account.address]);
                return;
            }
    
            try {
                const messagesRes = await fetch('https://api.mail.tm/messages', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const messagesData = await messagesRes.json();
    
                if (messagesData['hydra:member'].length === 0) {
                    document.getElementById('messageList').innerHTML = 'لا توجد رسائل بعد.';
                } else {
                    cachedMessages[account.address] = messagesData['hydra:member']; // تخزين الرسائل
                    displayMessages(messagesData['hydra:member']);
                }
            } catch (error) {
                console.error(error);
                showError("فشل في جلب الرسائل. تأكد من وجود اتصال بالإنترنت.");
            }
        }
    
        // عرض الرسائل
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            for (const msg of messages) {
                const fullMessageRes = fetch(`https://api.mail.tm/messages/${msg.id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => res.json());
                
                fullMessageRes.then(fullMessage => {
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `
                        <strong>من:</strong> ${fullMessage.from.address}<br>
                        <strong>الموضوع:</strong> ${fullMessage.subject}<br><br>
                        <details>
                            <summary>عرض الرسالة</summary>
                            <div class="message-body">${fullMessage.html || fullMessage.text || 'لا يوجد نص.'}</div>
                        </details>
                    `;
                    messageList.appendChild(div);
                }).catch(error => {
                    console.error('خطأ في جلب محتوى الرسالة:', error);
                });
            }
        }
    
        // عرض الإيميل في قائمة الإيميلات السابقة
        function addEmailToList(email) {
            const emailHistoryList = document.getElementById('emailHistoryList');
            const li = document.createElement('li');
            li.textContent = email;
            li.onclick = () => {
                document.getElementById('email').innerText = email;
                account = { address: email, password: account.password }; // تحديث الإيميل الذي سيتم العودة إليه
                fetchMessages();
                document.getElementById('backButton').style.display = 'inline-block';
            };
            emailHistoryList.appendChild(li);
        }
    
        // إظهار رسالة الخطأ
        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            errorBox.innerText = message;
            errorBox.style.display = 'block';
        }
    
        // العودة إلى الإيميل السابق
        function goBackToEmail() {
            if (account) {
                document.getElementById('email').innerText = account.address;
                fetchMessages();
            }
        }
    
        // نسخ الإيميل
        function copyEmail() {
            const emailText = document.getElementById('email').innerText;
            navigator.clipboard.writeText(emailText).then(() => {
                alert('تم نسخ الإيميل!');
            }).catch(err => {
                alert('حدث خطأ أثناء النسخ!');
            });
        }
    
        // بدء السكربت
        createAccount();
    </script>
    
    
</body>
</html>
